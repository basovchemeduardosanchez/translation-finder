<!-- !! -------------------------------------------------------------------- -->
<!-- SECTION TRANSLATION FINDER [2020-10-30T05:34:50.503Z] -->
<!-- ERROR: THE INSTRUCTIONS ARE NOT IN STEPPER FORMAT                       -->
<!-- ERROR: THE INSTRUCTIONS ARE NOT PRECISE                                 -->
<!-- ERROR: THERE IS NO FIELD FOR INSERTING FIELD                            -->
<!-- ERROR: THERE ARE SUBSECTIONS NOT PROPERLY FORMATTED                     -->
<!-- !! -------------------------------------------------------------------- -->
<!-- SECTION PENDING TASKS [2020-10-30T05:35:57.302Z] -->
<!-- :: [X] CONNECT THE APPLICATION TO GOOGLE SPREADSHEETS SO THE CATALOGS ARE GENERATED BY A SCRIPT INSTEAD INJECTING THE JSON  -->
    <!-- :: [X] GENERATE THE ENDPOINT DISPATCHER IN GOOGLE SCRIPTS TO SEND THE JSON OBJECT  -->
    <!-- :: [] GENERATE AN API ON TOP A SPREADSHEET TO DISPATCH READ AND WRITE DATA BASE  -->
    <!-- :: [X] COLLECT THE JSON OBJECT WITH THE APPLICATION  -->
<!-- :: [] ELABORATE A SCHEMATIC DESCRIBING THE FUNCTIONALITY OF THIS APPLICATION  -->
<!-- :: [X] IMPROVE THE INTERFACE OF THE TRANSLATION FINDER  -->
<!-- !SECTION PENDING TASKS  -->
<!-- !! -------------------------------------------------------------------- -->
<!-- SECTION README  [2020-11-03T01:14:31.972Z] -->
<!-- :: [] Complete the following text providing more detail about the project   -->
<!-- :: [] CREATE A USER MANUAL ON HOW TO USE AN EDIT THE FILE   -->
<!-- CONFIGURATION: TABLE INSERTION  -->
<!-- * This application is intended to serve as a UI for a Google Spreadsheet to filter data based on the column's contents. Each column in the spreadsheet will be presented in the interface with a search field below on which you can enter text to filter the rows that match with that search -->
<!-- * Modify the `lSpreadsheetUrl` variable below to change the default spreadsheet with which the application starts -->
<!-- * For a spreadsheet to work with this application, you should publish it as a web page to do so: -->
<!-- * 1. Create a Spreadsheet -->
<!-- * 2. Add data to the spreadsheet, at least 1 column and two rows -->
<!-- * 3. Click on File -->
<!-- * 4. Click on Publish for the Web -->
<!-- * 5. Select "All Document" and "Web Page" -->
<!-- * 6. Publish the document -->
<!-- * 7. Copy the link in the address bar -->
<!-- * 9. Paste the link in the "Spreadsheet URL" field in this application -->
<!-- !SECTION README -->
<!-- !! -------------------------------------------------------------------- -->
<!-- SECTION CSS [2020-10-30T05:30:03.518Z] -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous" />
<link rel="stylesheet" href="https://static.oracle.com/cdn/apex/19.2.0.00.18/libraries/font-apex/2.1/css/font-apex.min.css" />
<!-- !SECTION CSS -->
<!-- !! -------------------------------------------------------------------- -->
<!-- SECTION HTML [2020-10-30T05:28:56.952Z] -->
<div class="container p-4">
    <div class="row">
        <div class="col">
            <h1>
                Translation Finder 2.1.0
            </h1>
        </div>
    </div>
    <div class="row mb-2 spreadsheetControls"></div>
    <div class="row">
        <div class="col content"></div>
    </div>
</div>
<!-- !SECTION HTML  -->
<!-- !! -------------------------------------------------------------------- -->
<!-- SECTION JS [2020-10-30T05:29:41.483Z] -->
<script src="https://code.jquery.com/jquery-3.5.0.min.js" integrity="sha256-xNzN2a4ltkB44Mc/Jz3pT4iU1cmeR0FkXs4pru/JxaQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
<script>
    // IMPORTANT: Change this URL to the default spreadsheet. The spreadsheet must be "Published for the web"
    let lSpreadsheetUrl = 'https://docs.google.com/spreadsheets/d/1gJOQ1Q6sv_8wXmcgVA1CfeQ04XmjQronXyypvBle7D8/edit#gid=0',
        lSheetNumber = 1;
    // !! --------------------------------------------------------------------------
    // SECTION JQUERY TABLE SEARCH [2020-11-03T01:20:10.370Z]
    ( function( $ ){
        // TODO: Document
        /**
         * Hides the rows that don't match with pSearch string
         * 
         * @param {jQuery} pSearchableRows$ The set of jQuery elements containing the rows that 
         * will be affected by the search
         * @param {number} pSearchColumnIndex The index, starting from zero, of the column
         * to which the search will be limited
         * @param {string} pSearchString The value that the row will be searching for
         * @param {boolean} pSearchInRowHeaders whether to search inside of the <th> elements
         * of each row
         * @param {jQuery} pNoDataFoundCaption$ A jQuery element that will be shown when
         * nothing has been found  
         */
        function searchInRows( pSearchableRows$, pSearchString, pSearchColumnIndex, pSearchInRowHeaders, pNoDataFoundCaption$ ){
            var lResults$ = $();

            // If the input value is empty
            if ( pSearchString.length === 0 ) {
                // Show all rows
                pSearchableRows$.show();
                // If the input value is not empty
                if (pNoDataFoundCaption$) {
                    pNoDataFoundCaption$.hide();
                }
            } else {
                // Hide all rows
                pSearchableRows$.hide();
                // Then only show the rows that contain the text
                // we searched for in their <td>s
                pResults$ = pSearchableRows$.each( function(){
                    var lRow$ = $( this );
                    // Look for the <td>s that contain the
                    // search string
                    lRow$
                        .find( 'td' + ( pSearchInRowHeaders ? ', th' : '' ) )
                        // Changed :contains in jQuery for a filter because the contains
                        // is case sensitive by default and the plugins we found to make
                        // it case insensitive make it hard to match special characters
                        // even when the contains expression is escaped using
                        // $.escapeSelector
                        .filter( function( pIndex, pElement ){
                            var lResult = false;
                            if( ( pSearchColumnIndex !== undefined && pIndex === pSearchColumnIndex ) || pSearchColumnIndex === undefined ){
                                // Compare the uppercase version of the element's text with
                                // the uppercase search string
                                lResult = pElement.innerText.toUpperCase().indexOf( pSearchString.toUpperCase() ) >= 0;
                            }

                            return lResult;
                        } )
                        // Then find their parent rows
                        .parents('tr')
                        // And show them
                        .show();
                } )

                if ( pNoDataFoundCaption$ ) {
                    if ( pResults$.length > 0 ){
                        pNoDataFoundCaption$.hide();
                    } else {
                        pNoDataFoundCaption$.show();
                    }
                }
            }
        }
        $.fn.setupTableSearch = function( pSearchInput$, pSearchButton$, pOptions ) {
            var lOptions = $.extend( true, {
                searchInRowHeaders: false,
                searchColumnIndex: undefined, 
                rowsToSkip: 0
            }, pOptions );
            this
                .filter( 'table' )
                // QUESTION: Should it work for multiple tables if it only receives a single search input?
                // ANSWER: This should be controlled by a toggle
                .eq( 0 )
                .each( function(){
                    var lTable$ = $( this ),
                        lTBody$ = lTable$.find( 'tbody' ),
                        lSearchableRows$,
                        lNoDataFoundCaption$ = $('<div></div>')
                            .css( {
                                padding: 20,
                                'text-align': 'center',
                                position: 'sticky',
                                left: '50%',
                                display: 'inline-block',
                                transform: 'translateX( -50% )'
                            } )
                            .text('No data found')
                            .hide();

                    lTable$.after( lNoDataFoundCaption$ );
                    if ( lTBody$.length > 0 ){
                        lSearchableRows$ = lTBody$
                            .find( 'tr' );
                    } else {
                        lSearchableRows$ = lTable$
                            .find('tr');
                    }
                    lSearchableRows$ = lSearchableRows$.slice( lOptions.rowsToSkip );

                    pSearchInput$.keyup( function( pEvent ){
                        searchInRows(
                            lSearchableRows$,
                            // Get the value of the input
                            $( this ).val(),
                            lOptions.searchColumnIndex,
                            lOptions.searchInRowHeaders,
                            lNoDataFoundCaption$
                        );
                    } );

                    if( pSearchButton$ ){
                        pSearchButton$.click( function(){
                            searchInRows(
                                lSearchableRows$,
                                // Get the value of the input
                                pSearchInput$.val(),
                                lOptions.searchInRowHeaders,
                                lNoDataFoundCaption$
                            );
                        } );
                    }
                } );
            return this;
        }
    }( jQuery ) );
    // !SECTION JQUERY TABLE SEARCH
    // !! --------------------------------------------------------------------------
    function getSpreadsheetJsonUrl( pSpreadsheetUrl, pSheetNumber=1 ){
        let lSpreadsheetId = pSpreadsheetUrl.replace( /.*?\/d\/([^\/]*?)\/.*/, '$1' );
        // IMPORTANT: This URL has a special format of `https://spreadsheets.google.com/feeds/cells/<SPREADSHEET_ID>/<SHEET_NUMBER>/public/full?alt=json` you can get the `SPREADSHEET_ID` from the URL of the sheet and the `SHEET_NUMBER` would be from 1 to n depending on the order of the sheets
        return `https://spreadsheets.google.com/feeds/cells/${ lSpreadsheetId }/${ pSheetNumber }/public/full?alt=json`;
    }
    async function init(){
        // !! ----------------------------------------------------------------------
        // SECTION DATA [2020-11-03T01:19:03.879Z]
        try {
            const lSpreadsheetData = await fetch(
                getSpreadsheetJsonUrl( lSpreadsheetUrl, lSheetNumber )
            )
                .then( ( pResponse ) => pResponse.json() )
                .then( ( pData ) => {
                    let lTabularData = {};
                    pData.feed.entry.forEach( ( pValue ) => {
                        lTabularData[ pValue.gs$cell.row ] = lTabularData[ pValue.gs$cell.row ] || {};
                        lTabularData[ pValue.gs$cell.row ][ pValue.gs$cell.col ] = {
                            content: pValue.content.$t,
                            cell: {
                                name: pValue.title.$t,
                                row: pValue.gs$cell.row,
                                column: pValue.gs$cell.col
                            }
                        }
                    } );
                    lTabularData = Object.entries( lTabularData ).map( ( [ pKey, pValue ] ) => {
                        return Object.values( pValue )
                            .sort( ( pColumnA, pColumnB ) => {
                                return Number( pColumnA.cell.column ) - Number( pColumnB.cell.column );
                            } );
                    } ).sort( ( pRowA, pRowB ) => {
                        // If both row A and row B have cell values
                        return pRowA[ 0 ] && pRowB[ 0 ] ?
                            // Compare their row values to sort
                            Number( pRowA[ 0 ].cell.row ) - Number( pRowB[ 0 ].cell.row )
                            :
                            0;
                    } );
                    return lTabularData;
                } );
            // Assuming the first row contains the header values
            const lDataHeaders = lSpreadsheetData[ 0 ] ?
                lSpreadsheetData[ 0 ].map( ( pValue ) => {
                    return pValue.content;
                } )
                :
                {};
            const lData = lSpreadsheetData
                // Don't count index 0 as that's our headers
                .filter( ( pValue, pIndex ) => pIndex > 0 )
                .map( ( pValue ) => {
                    let lResult = {};
                    for( let i = 0; i < lDataHeaders.length; i++ ){
                        lResult[ lDataHeaders[ i ] ] = pValue[ i ] ? pValue[ i ].content : '';
                    }
                    return lResult;
                } );
            // !SECTION DATA
            // !! ----------------------------------------------------------------------
            // SECTION RENDER TABLE [2020-11-03T01:20:14.771Z]
            $( document ).ready( function(){
                let lContainer$ = $( '.content' )
                        .empty(),
                    lSpreadsheetControlsContainer$ = $( '.spreadsheetControls' )
                        .empty(),
                    lSpreadsheetUrlLabel$ = $( '<label style="display: block;">Spreadsheet URL</label>' )
                        .appendTo(
                            $( '<div class="form-group col"></div>' )
                                .appendTo( lSpreadsheetControlsContainer$ )
                        ),
                    lSheetNumberLabel$ = $( '<label style="display: block;">Sheet Number</label>' )
                        .appendTo(
                            $( '<div class="form-group col"></div>' )
                                .appendTo( lSpreadsheetControlsContainer$ )
                        ),
                    lSpreadsheetUrlInput$ = $( '<input class="form-control" type="text" placeholder="Sharing URL" />' )
                        .val( lSpreadsheetUrl )
                        .appendTo( lSpreadsheetUrlLabel$ )
                        .on( 'input', ( pEvent ) => {
                            lSpreadsheetUrl = $( pEvent.target ).val();
                            init();
                        } ),
                    lSheetNumberInput$ = $( '<input class="form-control" type="number" min="1" placeholder="Sheet Number" />' )
                        .val( lSheetNumber )
                        .appendTo( lSheetNumberLabel$ )
                        .on( 'input', ( pEvent ) => {
                            lSheetNumber = $( pEvent.target ).val();
                            init();
                        } ),
                    // !! The table will be appended to the container at the end
                    lTable$ = $( '<table class="table table-striped table-dark"></table>' ),
                    lTableHeader$ = $( '<thead></thead>' )
                        .appendTo( lTable$ ),
                    lTableBody$ =  $( '<tbody></tbody>' )
                        .appendTo( lTable$ ),
                    // Get the keys of the first objects in the array
                    lHeadersNames = Object.keys( lData[ 0 ] ),
                    lHeadersRow$ = $( '<tr></tr>' )
                        .appendTo( lTableHeader$ );
                for ( let i = 0; i < lHeadersNames.length; i++ ){
                    let lHeader$ = $( '<th></th>' )
                        .text( lHeadersNames[ i ] )
                        // We put the element we just have created into the row
                        .appendTo( lHeadersRow$ );
                }
                for ( let i = 0; i < lData.length; i++ ) {
                    let lRow$ = $( '<tr></tr>' )
                        // We put the element we just have created into the 
                        // Table body because we are starting a new row
                        .appendTo( lTableBody$ );
                    let lColumns = Object.keys( lData[ i ] );
                    for( let j = 0; j < lColumns.length; j++ ){
                        var lCell$ = $( '<td></td>' )
                            // lColumns[ j ] is the object key that we will pick
                            // lData on i will retur an objects and afterwards we get the
                            // key from the object
                            .text( lData[ i ][ lColumns[ j ] ] )
                            .appendTo( lRow$ );
                    }
                }
                // !SECTION RENDER TABLE
                // !! ------------------------------------------------------------------
                // SECTION SEARCH CONFIGURATION [2020-11-03T01:21:47.141Z]
                let lSearchFieldsRow$ = $( '<tr></tr>' )
                    .appendTo( lTableHeader$ );
                for( let i = 0; i < lHeadersNames.length; i++ ){
                    let lSearchFieldCell$ = $( '<td></td>' )
                            .appendTo( lSearchFieldsRow$ ),
                        lSearchField$ = $( `<input class="form-control" style="font-family: 'Font APEX Small', var(--font-family-sans-serif);" type="text" placeholder="&#xF002; ${ lHeadersNames[ i ] }" />` )
                            .appendTo( lSearchFieldCell$ );
                    // :: [] When a searchfield is focused, clear the others
                    lTable$.setupTableSearch(
                        lSearchField$,
                        undefined,
                        {
                            searchInRowHeaders: false,
                            searchColumnIndex: i,
                            rowsToSkip: 0
                        }
                    );
                }
                lTable$.appendTo( lContainer$ );
                // !SECTION SEARCH CONFIGURATIONS
                // !! ------------------------------------------------------------------
            } );
        } catch( pException ) {
            $( document ).ready( function(){
                $( '.content' )
                    .empty()
                    .append(
                        $( '<div class="alert alert-danger">An error occurred while fetching the data<br/></div>' )
                            .append( $( '<pre class="mb-0 mt-2"></pre>' ).text( pException.message ) )
                            .append( $( '<pre class="mb-0 mt-2"></pre>' ).text( pException.stack ) )
                    )
            } );
        }
    };
    init();
</script>
<!-- !SECTION JS -->
<!-- !! -------------------------------------------------------------------- -->
<!-- !SECTION FINDER -->
<!-- !! -------------------------------------------------------------------- -->
